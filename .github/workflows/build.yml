name: Build OnePlus SM7675 (Nord 4) + SUSFS (auto-detect defconfig)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  # If auto-detection fails, override DEFCONFIG here, e.g. "avalon_defconfig" or "sm7675_defconfig"
  # You can change this value from the workflow UI when doing "Run workflow".
  DEFCONFIG_OVERRIDE: ""

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Checkout repo (this repo)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Clone OnePlusOSS common kernel (branch you provided)
      run: |
        # clone the exact branch you gave (change URL only if you want a different mirror)
        git clone --depth 1 --branch oneplus/sm7675_b_16.0.0_nord_4 https://github.com/OnePlusOSS/android_kernel_common_oneplus_sm7675.git common || ( echo "Clone failed" && exit 1 )
        echo "Cloned OnePlus common kernel into ./common"

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y bc build-essential ccache flex bison \
          libssl-dev libncurses5-dev device-tree-compiler curl unzip \
          python3 python3-pip gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          android-tools-fastboot
        ccache -M 10G

    - name: Setup environment vars
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
        echo "KBUILD_BUILD_USER=github" >> $GITHUB_ENV
        echo "KBUILD_BUILD_HOST=gha" >> $GITHUB_ENV

    - name: Prepare device sources (if you included device-tree / vendor in repo)
      run: |
        # If you place your device tree or vendor files in `device/` or `modules_and_devicetree/` in your repo,
        # copy them into the common kernel tree. Edit these paths if needed.
        if [ -d device ]; then
          echo "Copying device/ -> common/device/"
          cp -r device common/device || true
        fi
        if [ -d modules_and_devicetree ]; then
          echo "Copying modules_and_devicetree/ -> common/"
          cp -r modules_and_devicetree/* common/ || true
        fi

    - name: Apply SUSFS patches (if any)
      run: |
        if [ -d susfs/patches ]; then
          echo "Applying SUSFS patches from susfs/patches..."
          for p in susfs/patches/*.patch; do
            echo "==> Applying $p"
            git -C common apply "$p" || ( echo "Patch apply failed: $p" && exit 1 )
          done
        else
          echo "No susfs/patches folder found â€” skipping patch application."
        fi

    - name: Auto-detect defconfig
      id: detect
      run: |
        set -e
        cd common
        # look for likely defconfig names
        CANDIDATES=$(ls arch/arm64/configs || true)
        FOUND=""
        # prefer exact matches that include sm7675 or avalon or nord
        for name in $CANDIDATES; do
          lower=$(echo "$name" | tr '[:upper:]' '[:lower:]')
          if echo "$lower" | grep -E "sm7675|avalon|nord|oneplus" >/dev/null; then
            FOUND="$name"
            break
          fi
        done
        # if override provided by workflow input / env, use it
        if [ -n "${{ env.DEFCONFIG_OVERRIDE }}" ]; then
          echo "Using DEFCONFIG_OVERRIDE: ${{ env.DEFCONFIG_OVERRIDE }}"
          FOUND="${{ env.DEFCONFIG_OVERRIDE }}"
        fi
        # also allow user override via workflow_dispatch input - read runtime env
        if [ -n "${{ github.event.inputs.defconfig }}" ]; then
          echo "Using runtime input defconfig: ${{ github.event.inputs.defconfig }}"
          FOUND="${{ github.event.inputs.defconfig }}"
        fi
        if [ -z "$FOUND" ]; then
          echo "No matching defconfig auto-detected."
          echo "DETECTED=NONE" >> $GITHUB_OUTPUT
          exit 0
        fi
        echo "DETECTED=$FOUND" >> $GITHUB_OUTPUT
        echo "Detected defconfig: $FOUND"

    - name: Prepare defconfig and build (if detected)
      if: steps.detect.outputs.DETECTED != 'NONE'
      working-directory: common
      run: |
        set -e
        DEF="${{ steps.detect.outputs.DETECTED }}"
        echo "Using defconfig: $DEF"
        make O=out ARCH=arm64 $DEF
        make -j$(nproc) O=out ARCH=arm64

    - name: Show message if defconfig not found
      if: steps.detect.outputs.DETECTED == 'NONE'
      run: |
        echo "Could not auto-detect a defconfig. Please:"
        echo " - open common/arch/arm64/configs to find the correct defconfig filename (eg. avalon_defconfig)"
        echo " - set env DEFCONFIG_OVERRIDE in repository secrets or pass via workflow_dispatch input 'defconfig'"
        exit 1

    - name: Build modules (if kernel built)
      working-directory: common
      if: steps.detect.outputs.DETECTED != 'NONE'
      run: |
        set -e
        make O=out ARCH=arm64 modules || true
        make O=out ARCH=arm64 modules_install INSTALL_MOD_PATH=out/modules || true

    - name: Collect artifacts
      if: steps.detect.outputs.DETECTED != 'NONE'
      run: |
        mkdir -p build_out
        cp -v common/out/arch/arm64/boot/Image build_out/ || true
        # collect DTBs (pattern may vary)
        cp -v common/out/arch/arm64/boot/dts/**/*.dtb build_out/ 2>/dev/null || true
        tar -C common/out -czf build_out/modules.tar.gz modules || true
        ls -lah build_out || true

    - name: Upload artifacts
      if: steps.detect.outputs.DETECTED != 'NONE'
      uses: actions/upload-artifact@v4
      with:
        name: nord4-sm7675-kernel
        path: build_out
