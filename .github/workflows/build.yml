name: Build Nord 4 Kernel (boot.img)

on:
  workflow_dispatch:

env:
  ARCH: arm64
  SUBARCH: arm64
  CC: clang
  LLVM: 1
  LLVM_IAS: 1

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Packages
      run: |
        sudo apt update
        sudo apt install -y bc bison build-essential flex git \
        curl wget gcc-aarch64-linux-gnu clang lld llvm python3 \
        libssl-dev libncurses5-dev device-tree-compiler lz4 zip

    - name: Apply KernelSU NEXT
      run: |
        mkdir logs
        curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh -o logs/kernelsu.sh
        bash logs/kernelsu.sh | tee logs/kernelsu.log

    - name: Kernel Config
      run: |
        export ARCH=arm64
        make gki_defconfig

    - name: Build Kernel
      run: |
        export ARCH=arm64
        export CC=clang
        export LLVM=1
        export LLVM_IAS=1
        make -j$(nproc)

    - name: Build Modules
      run: |
        export ARCH=arm64
        make modules -j$(nproc) || true
        make modules_install INSTALL_MOD_PATH=modules || true

    - name: Collect Kernel Files
      run: |
        mkdir -p out
        cp arch/arm64/boot/Image.lz4 out/ || true
        cp arch/arm64/boot/Image out/ || true
        cp arch/arm64/boot/dts/**/*.dtb out/ 2>/dev/null || true
        cp arch/arm64/boot/dts/**/*.dtbo out/ 2>/dev/null || true
        ls -lah out

    - name: Download mkbootimg
      run: |
        wget https://android.googlesource.com/platform/system/tools/mkbootimg/+archive/refs/heads/master.tar.gz -O mkbootimg.tar.gz
        mkdir mkbootimg
        tar -xzf mkbootimg.tar.gz -C mkbootimg
        chmod +x mkbootimg/mkbootimg.py

    - name: Create boot.img
      run: |
        cd out

        # decompress if needed
        if [ -f Image.lz4 ]; then
          lz4 -d Image.lz4 Image
        fi

        # find dtb
        DTB=$(find . -name "*.dtb" | head -n 1)
        DTBO=$(find . -name "*.dtbo" | head -n 1)

        if [ ! -f Image ]; then
          echo "ERROR: Kernel Image not found"
          exit 1
        fi

        python3 ../mkbootimg/mkbootimg.py \
          --kernel Image \
          ${DTB:+--dtb $DTB} \
          ${DTBO:+--dtbo $DTBO} \
          --output boot.img

        cd ..

        echo "BOOT IMAGE CREATED:"
        ls -lah out/boot.img

    - name: Upload boot.img
      uses: actions/upload-artifact@v4
      with:
        name: nord4-bootimg
        path: out/boot.img

    - name: Upload Logs
      uses: actions/upload-artifact@v4
      with:
        name: kernelsu-log
        path: logs/kernelsu.log
